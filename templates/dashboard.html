{% extends 'base.html' %}
{% block title %}Панель керування{% endblock %}
{% block content %}
<h1 class="text-3xl font-bold mb-6">Панель керування - {{ role | capitalize }}</h1>

{% if role == 'manager' %}
<div class="mb-6">
    <h2 class="text-xl font-bold">Керування атракціонами</h2>
    <a href="{{ url_for('add_attraction') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Додати новий атракціон</a>
    <a href="{{ url_for('manage_ticket_prices') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-2">Керувати цінами квитків</a>
</div>
{% endif %}

{% if role == 'cashier' %}
<div class="mb-6">
    <h2 class="text-xl font-bold">Продаж квитків</h2>
    <a href="{{ url_for('ticket_purchase') }}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Продати квиток</a>
</div>
{% endif %}

<h2 class="text-xl font-bold mb-4">Атракціони</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% for attraction in attractions %}
    <div class="bg-white p-4 rounded shadow">
        <h3 class="text-lg font-bold">{{ attraction.name }}</h3>
        <p>Статус: {{ attraction.status }}</p>
        <p>Місткість: {{ attraction.capacity }}</p>
        {% if role in ['technician', 'manager'] %}
        <form class="update-attraction-form" data-attraction-id="{{ attraction.id }}">
            <select name="status" class="p-2 border rounded">
                <option value="active" {% if attraction.status == 'active' %}selected{% endif %}>Активний</option>
                <option value="maintenance" {% if attraction.status == 'maintenance' %}selected{% endif %}>На обслуговуванні</option>
                <option value="inactive" {% if attraction.status == 'inactive' %}selected{% endif %}>Неактивний</option>
            </select>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Оновити</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
</div>

{% if role == 'manager' %}
<div class="mt-6">
    <h2 class="text-xl font-bold mb-4">Фінансовий звіт</h2>
    <select id="report-period" class="p-2 border rounded">
        <option value="all">За весь час</option>
        <option value="day">Денний</option>
        <option value="week">Тижневий</option>
        <option value="month">Місячний</option>
    </select>
    <button onclick="fetchReport()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Сформувати звіт</button>
    <div id="report" class="mt-4"></div>
</div>
{% endif %}

{% if role == 'technician' %}
<div class="mt-6">
    <h2 class="text-xl font-bold mb-4">Записи про обслуговування</h2>
    <ul>
        {% for record in maintenance_records %}
        <li class="bg-white p-4 rounded shadow mb-2">
            <p>{{ record.description }}</p>
            <p>Статус: {{ record.status }}</p>
            <p>Дата: {{ record.date }}</p>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<script>
    // Обробка фінансового звіту
    async function fetchReport() {
        const period = document.getElementById('report-period').value;
        const response = await fetch(`/api/report?period=${period}`);
        const data = await response.json();
        if (data.error) {
            document.getElementById('report').innerHTML = `<p class="text-red-500">${data.error}</p>`;
        } else {
            let ticketTypesHtml = '<ul>';
            for (const [type, count] of Object.entries(data.ticket_types)) {
                ticketTypesHtml += `<li>${type.charAt(0).toUpperCase() + type.slice(1)}: ${count}</li>`;
            }
            ticketTypesHtml += '</ul>';
            document.getElementById('report').innerHTML = `
                <p>Загальний дохід: $${data.total_revenue}</p>
                <p>Кількість транзакцій: ${data.transaction_count}</p>
                <p>Розподіл за типами квитків:</p>
                ${ticketTypesHtml}
            `;
        }
    }

    // Обробка оновлення атракціонів через AJAX
    document.querySelectorAll('.update-attraction-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const attractionId = form.getAttribute('data-attraction-id');

            try {
                const response = await fetch(`/attraction/update/${attractionId}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.message) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Успіх',
                        text: data.message,
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else if (data.error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Помилка',
                        text: data.error
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Помилка',
                    text: 'Не вдалося оновити атракціон'
                });
            }
        });
    });
</script>
{% endblock %}